{% extends "base.html" %}
{% load staticfiles %}
{% block title %}
    用户管理
{% endblock %}

{% block style %}

    <script src="{% static 'jquery/jquery-1.10.1.js' %}"></script>
    {#    <script src="{% static 'cmdb/js/user.js' %}"></script>#}
    <script>
        function userSave() {
            var data = $('#Register').serializeArray();
            var dict = {};
            //$.each(data, function () {
            //    dict[this.name] = this.value
            //});
            //dict.username = $('#id_username').val();
            //dict.password = $('#id_password').val();
            //dict.photo = $('#id_photo').val();
            {#var username = $("#id_username").val();#}
            {#var password = $('#id_password').val();#}
            {#var photo = $('#id_photo')[0].files[0];#}
            {#console.log(photo);#}

            var sendData = new FormData();
            sendData.append("username",$("#id_username").val());
            sendData.append("password",$("#id_password").val());
            sendData.append("photo",$("#id_photo")[0].files[0]);
            sendData.append("csrfmiddlewaretoken","{{ csrf_token }}");

            console.log(sendData);
            dict['csrfmiddlewaretoken'] = '{{ csrf_token }}';
            $.ajax(
                {
                    url: '/user/user_save',
                    type: 'post',
                    data: sendData,
                    processData : false, // 告诉jQuery不要去处理发送的数据
                    contentType : false, // 告诉jQuery不要去设置Content-Type请求头
                    success: function (data) {
                        console.log(data.data);
                        //$('.top-left').notify({
                         //   message: { text: 'Aw yeah, It works!' }
                        //}).show();
                    },
                    error: function (error) {
                        console.log(error.data);
                        //$('.top-left').notify({
                        //    message: { text: 'Aw yeah, It works!' }
                        ///}).show();
                    }
                }
            )
        }

        $(function () {

            //用户注册表单验证
            $('#Register').bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    username: {
                        message: '用户名验证失败',

                        validators: {
                            notEmpty: {
                                message: '用户名不能为空'
                            },
                            stringLength: {
                                min: 6,
                                max: 32,
                                message: '用户名长度必须在6到32之间'
                            },
                            regexp: {
                                regexp: /^[a-zA-Z0-9_]+$/,
                                message: '用户名只能包含大写、小写、数字和下划线'
                            },
                            defferent: {
                                field: 'password',
                                message: '用户名不允许和密码相同'
                            },
                            //ajax方式验证用户名是否已注册
                            threshold: 6, //有6字符以上才发送ajax请求
                            remote: {
                                type: 'POST',
                                url: '/user/userValid/',
                                data: {
                                    username: function () {
                                        return $('#username').val();
                                    },
                                    //下面这种方式只适合js写在html页面中的情况
                                    csrfmiddlewaretoken:'{{ csrf_token }}'
                                },
                                delay: 1000,  //每输入一个字符，就发ajax请求，服务器压力还是太大，设置1秒发送一次ajax（默认输入一个字符，提交一次，服务器压力太大）
                                message: '用户名已存在'
                            }
                        }
                    },
                    password: {
                        validators: {
                            notEmpty: {
                                message: '密码不能为空'
                            },
                            stringLength: {
                                min: 6,
                                max: 32,
                                message: '密码长度必须在6到32之间'
                            },
                            regexp: {
                                regexp: /^(?=.*\d)(?=.*[a-zA-Z])(?=.*[~!@#$%^&*.])[\da-zA-Z~!@#$%^&*.]+$/,
                                message: '密码必须包含数字、字母和特殊字符'
                            },
                            defferent: {
                                field: 'username',
                                message: '密码不允许和用户名相同'
                            }
                        }
                    }
                }
            });

            //用户注册提交按钮
            $('#UserSubmit').click(
                function () {
                    userSave();
                }
            )

        });
    </script>
{% endblock %}

{% block label %}
    用户管理
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-11">
            <button type="button" class="btn btn-primary btn-lg navbar-right" data-toggle="modal"
                    data-target="#userRegister">
                添加用户
            </button>

            <div class="modal fade" id="userRegister" tabindex="-1" role="dialog" aria-labelledby="userRegister">
                <div class="modal-dialog" role="document">
                    <div class="modal-content"><!--模态框内容开始-->
                        <div class="modal-header"><!--模态框标题-->
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
                            <h4 class="modal-title" id="ourRegisterTitle">用户注册</h4>
                        </div>
                        <div class="modal-body">
                            <form class="Register" id="Register" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label class="control-label">{{ register.username.label }}</label>
                                    {{ register.username }}
                                </div>
                                <div class="form-group">
                                    <label class="control-label">{{ register.password.label }}</label>
                                    {{ register.password }}
                                </div>
                                <div class="form-group">
                                    <label class="control-label">{{ register.photo.label }}</label>
                                    {{ register.photo }}
                                </div>
                            </form>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                <button id="UserSubmit" type="submit" class="btn btn-primary" data-dismiss="modal">提交
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}